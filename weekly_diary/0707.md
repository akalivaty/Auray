# 2024/07/10

## Todo

- [ ] Test with the full CNS16190 file
- [ ] Test [Cache embedding results](https://python.langchain.com/v0.2/docs/how_to/caching_embeddings/)
- [ ] Test [MultiQueryRetriever](https://python.langchain.com/v0.2/docs/how_to/MultiQueryRetriever/)

  MultiQueryRetriever generates variants of the input question to improve retrieval hit rate.

- [ ] Test [MultiVectorRetriever](https://python.langchain.com/v0.2/docs/how_to/multi_vector/)
  
  MultiVectorRetriever instead generates variants of the embeddings, also in order to improve retrieval hit rate.


# 2024/07/09

## Todo

- [ ] Use other retrieval methods
- [X] Test UnstructuredMarkdownLoader
- [X] Follow up with [official tutorial](https://python.langchain.com/v0.2/docs/tutorials/rag/)
- [X] Check [official langchain component](https://python.langchain.com/v0.1/docs/modules/data_connection/document_loaders/)

## Details

In `examples/official_rag_tutorial.ipynb`, follow the official tutorial to build a RAG model. It can be observed that the 2 methods of `UnstructuredMarkdownLoader` outperform the 3rd method `MarkdownHeaderTextSplitter`. 

> The query is "「當使用者可對裝置鑑別時，裝置應向使用者或管理者提供簡單機制，以變更所使用之鑑別值」屬於哪一項控制措施？".
> >
> The answer should be "控制措施5.1-4".

### Method 1 UnstructuredMarkdownLoader

```
AIMessage(content='控制措施5.1-4：當使用者可對裝置鑑別時，裝置應向使用者或管理者提供簡單機制，以變更所使用之鑑別值。製造者以要求最少步驟之方式，設計通行碼變更過程，並在使用者手冊及教學影片中解釋該過程。這項措施旨在使裝置的鑑別機制更容易且更安全。',...
```

### Method 2 UnstructuredMarkdownLoader with elemnets mode

```
AIMessage(content='控制措施5.1-4。',...
```

### Method 3 MarkdownHeaderTextSplitter

```
AIMessage(content='提供使用者或管理者機制以變更鑑別值是屬於鑑別機制的控制措施之一。這種機制可以讓鑑別值如指紋、通行碼等更易變更，提高裝置的安全性。建議使用通行碼等鑑別機制時，需遵循相關最佳實務作法。',...
```
However, there are some search mistakes in  the method 1, UnstructuredMarkdownLoader without elements mode. For example, if query "「對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由」屬於哪一項控制措施？", the anwser should be "控制措施4-1". But it returned:

```
「對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由」屬於「使系統對中斷具韌性」的控制措施。控制措施5.9-1至5.9-3旨在確保消費者IoT裝置在中斷情況下具有韌性，以確保服務持續運行。其他措施包括保持本地運作功能性、建構備援、及避免分散式阻絕服務攻擊。
```
Currently, it can be summarized that **UnstructuredMarkdownLoader** (method 1) provides long response description but has a lower retrieval accuracy. Whereas **UnstructuredMarkdownLoader with elements mode** (method 2) provides rigorous response and has a higher retrieval accuracy.


# 2024/07/08

## Todo

- [X] [LangChain 怎麼玩？用 LangSmith 幫忙追查問題](https://myapollo.com.tw/blog/langchain-langsmith/)
- [X] LangSmith: [LangChain 怎麼玩？用 LangSmith 幫忙追查問題](https://myapollo.com.tw/blog/langchain-langsmith/)
- [X] OpenAI model/embedding

## Details

In `examples/comparison_openai_hf.ipynb`, tested the following:

- Invoke OpenAI llm model to inference
- Invoke OpenAI embedding model to build a vector database
- PromptTemplate
- New chain method

OpenAI embedding is better than sentence-transformer `multi-qa-mpnet-base-dot-v1` in all 3 search methods, **similarity**, **similarity_score_threshold**, and **mmr**. For example, a query "「對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由」是控制措施哪一條？" is input, the answer should be "控制措施4-1", and the search results (k=5) from vector database are:

### OpenAI

### similarity

```
page_content='消費者IoT裝置不適用或未執行控制措施之情況包括：' metadata={'Header 1': '4. 報告實作', 'Header 2': '控制措施4-1：對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由。',...

page_content='。本標準旨在協助消費者IoT裝置製造者' metadata={'Header 1': '6. 消費者IoT裝置之資料保護控制措施',...

page_content='本標準中控制措施之實作' metadata={'Header 1': '4. 報告實作',...

page_content='若消費者IoT裝置偵測出對其軟體之未經授權的變更，其將能通知正確之利害相關者' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.7 確保軟體完整性', 'Header 3': '控制措施5.7-2：若偵測出對軟體之未經授權的變更，則裝置宜對使用者及/或管理者發出警示，且不宜連接至比執行警示功能所必要之網路更廣的網路。',...

page_content='，控制措施的適用性取決於各裝置' metadata={'Header 1': '4. 報告實作',...
```


### similarity_score_threshold

```
page_content='消費者IoT裝置不適用或未執行控制措施之情況包括：' metadata={'Header 1': '4. 報告實作', 'Header 2': '控制措施4-1：對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由。'...
page_content='。本標準旨在協助消費者IoT裝置製造者' metadata={'Header 1': '6. 消費者IoT裝置之資料保護控制措施'...

page_content='本標準中控制措施之實作' metadata={'Header 1': '4. 報告實作'...

page_content='若消費者IoT裝置偵測出對其軟體之未經授權的變更，其將能通知正確之利害相關者' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.7 確保軟體完整性', 'Header 3': '控制措施5.7-2：若偵測出對軟體之未經授權的變更，則裝置宜對使用者及/或管理者發出警示，且不宜連接至比執行警示功能所必要之網路更廣的網路。',...

page_content='，控制措施的適用性取決於各裝置' metadata={'Header 1': '4. 報告實作',...
```

### mmr

```
page_content='消費者IoT裝置不適用或未執行控制措施之情況包括：' metadata={'Header 1': '4. 報告實作', 'Header 2': '控制措施4-1：對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由。',...

page_content='本標準中控制措施之實作' metadata={'Header 1': '4. 報告實作',...

page_content='。〝非必要〞係指製造者對開啟用於使用者功能性或除錯目的之介面的利益之評量。' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.6 最小化暴露之攻擊面', 'Header 3': '控制措施5.6-3：裝置硬體不宜將實體介面非必要暴露於攻擊。',...

page_content='。本標準旨在協助消費者IoT裝置製造者' metadata={'Header 1': '6. 消費者IoT裝置之資料保護控制措施',...

page_content='，以及其他因素，諸如接觸裝置的能力或受限制裝置考量事項' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.3 保持軟體為最新', 'Header 3': '控制措施5.3-8：安全更新應及時。',...
```

### Sentence-transformer

### similarity

```
page_content='。本標準旨在協助消費者IoT裝置製造者' metadata={'Header 1': '6. 消費者IoT裝置之資料保護控制措施',...

page_content='，製造者不提供裝置未要求之任何背景過程、內核延伸、命令、程式或工具' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.6 最小化暴露之攻擊面', 'Header 3': '控制措施5.6-5：對裝置之預期用途或運作，製造者宜僅啟用其所使用或所要求的軟體服務。',...

page_content='。本標準透過使用非必備宜使用控制措施(建議)，提供一定程度之彈性。' metadata={'Header 1': '4. 報告實作',...

page_content='消費者IoT裝置不適用或未執行控制措施之情況包括：' metadata={'Header 1': '4. 報告實作', 'Header 2': '控制措施4-1：對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由。',...

page_content='。雖於裝置製造者自己之產品中對其修復至關重要' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.2 實作管理脆弱性報告之方式', 'Header 3': '控制措施5.2-3：製造者宜於所定義支援期間內，對其銷售及生產，以及所生產之產品及運作的服務，持續監視、識別及矯正安全脆弱性。',...
```

### similarity_score_threshold

```
page_content='。本標準旨在協助消費者IoT裝置製造者' metadata={'Header 1': '6. 消費者IoT裝置之資料保護控制措施',...

page_content='，製造者不提供裝置未要求之任何背景過程、內核延伸、命令、程式或工具' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.6 最小化暴露之攻擊面', 'Header 3': '控制措施5.6-5：對裝置之預期用途或運作，製造者宜僅啟用其所使用或所要求的軟體服務。',...

page_content='。本標準透過使用非必備宜使用控制措施(建議)，提供一定程度之彈性。' metadata={'Header 1': '4. 報告實作',...

page_content='消費者IoT裝置不適用或未執行控制措施之情況包括：' metadata={'Header 1': '4. 報告實作', 'Header 2': '控制措施4-1：對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由。',...

page_content='。雖於裝置製造者自己之產品中對其修復至關重要' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.2 實作管理脆弱性報告之方式', 'Header 3': '控制措施5.2-3：製造者宜於所定義支援期間內，對其銷售及生產，以及所生產之產品及運作的服務，持續監視、識別及矯正安全脆弱性。',...
```

### mnr

```
page_content='。本標準旨在協助消費者IoT裝置製造者' metadata={'Header 1': '6. 消費者IoT裝置之資料保護控制措施',...

page_content='，製造者不提供裝置未要求之任何背景過程、內核延伸、命令、程式或工具' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.6 最小化暴露之攻擊面', 'Header 3': '控制措施5.6-5：對裝置之預期用途或運作，製造者宜僅啟用其所使用或所要求的軟體服務。',...

page_content='本標準中控制措施之實作' metadata={'Header 1': '4. 報告實作',...

page_content='提供IoT產品之製造者有責任維護' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.2 實作管理脆弱性報告之方式', 'Header 3': '控制措施5.2-3：製造者宜於所定義支援期間內，對其銷售及生產，以及所生產之產品及運作的服務，持續監視、識別及矯正安全脆弱性。',...

page_content='2.於具數個微控制器(例：其一用於通訊，另一用於應用)之裝置上' metadata={'Header 1': '5. 消費者IoT裝置之網宇安全控制措施', 'Header 2': '5.3 保持軟體為最新', 'Header 3': '控制措施5.3-1：消費者IoT裝置中之所有軟體組件宜為可安全更新。',...
```

The responses inferenced by LLM are as follows. It can be observed that the response of hf LLM is wrong.

### OpenAI

```
AIMessage(content='這個要求符合「控制措施4-1：對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由」。該控制措施要求對於不適用或未滿足本標準的建議，製造者應詳細記錄相應的理由。這有助於製造者確保其裝置符合安全要求，並提供透明度和可追踪性。',...

```

### Huggingface (Breeze)

```
"System: 你是一個[Document(page_content='消費者IoT裝置不適用或未執行控制措施之情況包括：', metadata={'Header 1': '4. 報告實作', 'Header 2': '控制措施4-1：對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由。',...), Document(page_content='。本標準旨在協助消費者IoT裝置製造者', metadata={'Header 1': '6. 消費者IoT裝置之資料保護控制措施',...), Document(page_content='本標準中控制措施之實作', metadata={'Header 1': '4. 報告實作',...), Document(page_content='。對某些使用案例及下列風險評鑑，可適切應用額外控制措施及本標準內之控制措施。', metadata={'Header 1': '4. 報告實作',...)]，根據CNS16190消費者物聯網之網宇安全：基準要求事項，回答相關問題\nHuman: 「對本標準中視為不適用或消費者IoT裝置未滿足之各項建議，應記錄衡量理由」符合哪一項控制措施？"

```

# 2024/07/07

## Todo

- [X] [LLM Note Day 11 - 擁抱開源的微笑 Hugging Face Transformers](https://ithelp.ithome.com.tw/articles/10328377)
- [X] [全端 LLM 應用開發-Day26-用 Langchain 來做 PDF 文件問答](https://ithelp.ithome.com.tw/articles/10338349)
- [X] [Build an LLM RAG Chatbot With LangChain](https://realpython.com/build-llm-rag-chatbot-with-langchain/)